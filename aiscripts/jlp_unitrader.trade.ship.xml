<?xml version="1.0" encoding="iso-8859-1" ?>
<aiscript name="jlp.unitrader.trade.ship" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:noNamespaceSchemaLocation="aiscripts.xsd" version="1"
>
	<params>
		<param name="PageId" default="8570" />
		<param name="warelist" default="null" />
		<param name="range" default="null" />
		<!--if $range == 'ranged' then $additionalparams defines min and max jumps
			for the buy and sell ranges [$minbuy, $maxbuy, $minsell, $maxsell] -->
		<param name="additionalparams" default="[0,24,0,24]" />

		<param name="home" default="this.ship.cluster" />
		<param name="debugchance" default="0" />
		<param name="debugchance2" default="0" />
	</params>
	<init>
		<set_command command="command.wait" />
	</init>

	<attention min="unknown">
		<actions>
			<!-- set up initial state for trade runs -->
			<label name="start" />

			<do_if value="this.$jlpUniTraderRun" exact="true" negate="true">
				<return />
			</do_if>


			<set_value name="$Pilot" exact="this.knownname" />
			<set_value name="$buyoffer" exact="null" />
			<set_value name="$selloffer" exact="null" />

			<!-- Take a break -->
			<set_value name="$idletime" exact="this.$jlp_unitrader_waittime" />

			<run_script name="'move.idle'" sinceversion="1">
				<param name="TimeOut" value="$idletime" />
			</run_script>

			<!-- TODO: we should check for things like broken jump drive, so we can
				go in for repairs instead of endlessly trying to jump to a trade -->

			<set_value name="$sellrange" exact="null" />
			<set_value name="$buyrange" exact="null" />
	
			<do_if value="not @$range.isclass.space">
				<set_value name="$rangeMode" exact="$range"/>
				<do_if value="$range" exact="'zone'">
					<set_value name="$range" exact="$home" />
				</do_if>
				<do_elseif value="$range" exact="'sector'">
					<set_value name="$range" exact="$home.sector" />
				</do_elseif>
				<do_elseif value="$range" exact="'cluster'">
					<set_value name="$range" exact="$home.cluster" />
				</do_elseif>
				<do_elseif value="$range" exact="'ranged'">
					<set_value name="$range" exact="$home" />
					<set_value name="$sellrange" exact="[$additionalparams.{1}, $additionalparams.{2}]" />
					<set_value name="$buyrange" exact="[$additionalparams.{3}, $additionalparams.{4}]" />
				</do_elseif>
				<do_else>
					<set_value name="$range" exact="this.ship.sector" />
				</do_else>
			</do_if>

			<!-- TODO use default ware list unless it has been overridden by parameter -->
			<do_if value="$warelist == null">

			</do_if>


			<set_value name="this.$trade_failedfindruns" exact="0" />

			<label name="find trade run" />

			<do_if value="@this.ship.dockslot.component.external">
				<!-- make sure we clear the docking area asap -->
				<run_script name="'move.undock'" sinceversion="1" />
				<set_value name="$idletime" min="10s" max="30s" />
				<run_script name="'move.idle'" sinceversion="1">
					<param name="TimeOut" value="$idletime" />
				</run_script>
			</do_if>

			<run_script name="'jlp.unitrader.trade.findfreetraderun'" sinceversion="1">
				<param name="warelist" value="$warelist" />
				<param name="range" value="$range" />
				<param name="rangeMode" value="$rangeMode"/>
				<param name="sellrange" value="$sellrange" />
				<param name="buyrange" value="$buyrange" />
				<param name="debugchance" value="$debugchance" />
				<param name="debugchance2" value="$debugchance2" />
				<save_retval name="selloffer" variable="$selloffer" />
				<save_retval name="buyoffer" variable="$buyoffer" />
			</run_script>

			<!--If no trade was found then at least fly to the closest area where
				can buy before
				checking again -->
			<do_if value="this.$trade_failedfindruns" min="4">
			
				<!-- can't find anything good at the moment... wait a while, then check
				again -->
				<debug_text
					text="player.age + ' no good trade offer found, waiting for a while before checking again'"
					chance="$debugchance" />
					<set_value name="$idletime" exact="this.$jlp_unitrader_waittime" />
				<run_script name="'move.idle'" sinceversion="1">
					<param name="TimeOut" value="$idletime" />
				</run_script>
			
				<debug_text chance="$debugchance2"
					text="player.age + ': '  + this.ship.name + ': ' + this.name + ' No trade was found. Flying to other regions.'" />
				<!-- Skills -->
				<set_value name="$onlyKnownBuy" exact="false" />
				<set_value name="$onlyTraderBuy" exact="false" />
				<set_value name="$tradeRestrictionBuy" exact="this.$jlp_unitrader_trade_stations_buy" />

				<do_if value="$tradeRestrictionBuy == 'onlyKnownBuy'">
					<set_value name="$onlyKnownBuy" exact="true" />
				</do_if>
				<do_if value="$tradeRestrictionBuy == 'onlyTraderBuy'">
					<set_value name="$onlyTraderBuy" exact="true" />
				</do_if>

				<!--search for tradeoffer with warelist in Galaxy sort by distance -->
				<set_command command="command.move" />
				<wait exact="this.$jlp_unitrader_searchtime" sinceversion="1" />
				<!-- TODO check if $sellrange is the gate distance? -->
				<do_if value="$buyrange">
					<find_sector space="player.galaxy" multiple="true" name="$sectors">
						<match_gate_distance object="$home">
							<max min="$buyrange.{1}" max="$buyrange.{2}" />
						</match_gate_distance>
					</find_sector>
				</do_if>
				<do_else>
					<find_sector space="$range" multiple="true" name="$sectors" known="true" />
				</do_else>

				<wait min="200ms" max="800ms" sinceversion="1" />
				<create_list name="$tradeoffers" />
				<do_all exact="$sectors.count" counter="$Counter">
					<debug_text chance="$debugchance2"
						text="player.age + ': '  + this.ship.name + ': ' + this.name + ' sectors %1'.[$sectors.count]" />
					<wait min="20ms" max="80ms" sinceversion="1"/>
					<do_if value="$sectors.{$Counter} == this.ship.sector">
						<continue />
					</do_if>
					<find_sell_offer tradepartner="this.ship" result="$tradeoffer" multiple="true"
						space="$sectors.{$Counter}" wares="$warelist" knowntoplayer="$onlyKnownBuy"
					>
						<!-- TODO realtiveprice use with skill maybe -->
						<totalvolume min="1"/>
						<match_seller>
							<match_any>
								<match_relation faction="faction.player" comparison="exact" relation="friend" />
								<match_relation faction="faction.player" comparison="exact" relation="neutral" />
							</match_any>
						</match_seller>
						
					</find_sell_offer>
					<do_all exact="$tradeoffer.count" counter="$Counter2">
						<do_if value="this.ship.cargo.{$tradeoffer.{$Counter2}.ware}.max" min="1">
							<set_value name="$destination" exact="$tradeoffer.{$Counter2}.seller" />
							<do_if value="$destination.isclass.ship_xl" negate="true">
								<do_if value="(not $destination.tradenpc.container.hastradesubscription) and $onlyTraderBuy">
									<continue />
								</do_if>
							</do_if>

							<append_to_list name="$tradeoffers" exact="$tradeoffer.{$Counter2}" />
						</do_if>
					</do_all>
				</do_all>
				<debug_text chance="$debugchance2"
					text="player.age + ': '  + this.ship.name + ': ' + this.name + ' Found tradeoffers %1'.[$tradeoffers.count]" />

				<do_if value="$tradeoffers.count" min="1">
					<wait min="200ms" max="800ms" sinceversion="1" />
					<create_list name="$tradeoffersSort" />

					<sort_trades name="$tradeoffersSort" tradelist="$tradeoffers" sorter="relativeprice" />
					<wait min="200ms" max="800ms" sinceversion="1" />
					<remove_value name="$tradeoffers" />
					<do_all exact="$tradeoffersSort.count" counter="$Counter">
						<do_if value="$tradeoffersSort.{$Counter}.available">
							<debug_text chance="$debugchance2"
								text="player.age + ': ' + this.ship.name + ': ' + this.name + ' fly to %1 / %2 / %3 '.[$tradeoffersSort.{$Counter}.seller.sector.knownname, $tradeoffersSort.{$Counter}.seller.zone.knownname, $tradeoffersSort.{$Counter}.seller.knownname]" />
							<get_jump_cost ship="this.ship" start="this.ship.sector"
								end="$tradeoffersSort.{$Counter}.seller.sector" result="$trip" />
							<do_if value="this.ship.cargo.{ware.fuelcells}.count lt $trip + 100">
								<run_script name="'move.refuel'" sinceversion="1" />
							</do_if>

							<wait min="20ms" max="80ms" sinceversion="1" />
							<run_script name="'move.generic'" sinceversion="1">
								<param name="destination" value="$tradeoffersSort.{$Counter}.seller" />
							</run_script>
							<break />
						</do_if>
					</do_all>
					<remove_value name="$tradeofferSort" />
				</do_if>
				<set_value name="this.$trade_failedfindruns" exact="0" />
				<return />
			</do_if>
			<do_if value="(not $selloffer.exists and not $buyoffer.exists) or (not $buyoffer.exists)">
				<set_value name="this.$trade_failedfindruns" operation="add" exact="1" />
				<wait exact="this.$jlp_unitrader_waittime" sinceversion="1" />
				<resume label="find trade run" />
			</do_if>

			<label name="perform trade run" />

			<wait exact="this.$jlp_unitrader_searchtime" sinceversion="1" />
			<set_value name="this.$trade_failedfindruns" exact="0" />

			<!-- remember for notification -->
			<do_if value="$buyoffer.available">
				<set_value name="$Buyer" exact="$buyoffer.buyer" />
				<set_value name="$BuyerEntity" exact="$buyoffer.buyerentity" />
				<set_value name="$tradeBuyWare" exact="$buyoffer.ware" />
				<set_value name="$tradeBuyWareOfferAmount" exact="$buyoffer.offeramount.{this}" />
				<set_value name="$tradeBuyOfferUnitprice" exact="$buyoffer.unitprice" />
				<set_value name="$tradeBuyOfferPrice" exact="$buyoffer.price" />
			</do_if>
			<do_if value="$selloffer.available">
				<set_value name="$Seller" exact="$selloffer.seller" />
				<set_value name="$SellerEntity" exact="$selloffer.sellerentity" />
				<set_value name="$tradeSellWare" exact="$selloffer.ware" />
				<set_value name="$tradeSellWareOfferAmount" exact="$selloffer.offeramount.{this}" />
				<set_value name="$tradeSellOfferUnitprice" exact="$selloffer.unitprice" />
				<set_value name="$tradeSellOfferPrice" exact="$selloffer.price" />
			</do_if>


			<set_value name="$profit" exact="0" />
			<set_value name="$success" exact="false" />
			<do_while value="$selloffer.available or $buyoffer.available">
				<do_if value="this.ship.isclass.ship_l or this.ship.isclass.ship_xl">
					<do_if value="@$buyoffer.available">
						<get_jump_cost ship="this.ship" start="this.ship.sector" end="$buyoffer.buyer.sector"
							result="$trip" />
						<do_if value="this.ship.cargo.{ware.fuelcells}.count lt $trip + 100">
							<run_script name="'move.refuel'" sinceversion="1" />
						</do_if>
					</do_if>
					<do_if value="not @$buyoffer.available and  @$selloffer.available">
						<get_jump_cost ship="this.ship" start="this.ship.sector" end="$selloffer.seller.sector"
							result="$trip" />
						<do_if value="this.ship.cargo.{ware.fuelcells}.count lt $trip + 100">
							<run_script name="'move.refuel'" sinceversion="1" />
						</do_if>
					</do_if>
				</do_if>

				<run_script name="'jlp.unitrader.trade.performtraderun'" sinceversion="1">
					<param name="selloffer" value="$selloffer" />
					<param name="buyoffer" value="$buyoffer" />
					<param name="debugchance" value="$debugchance" />
					<save_retval name="success" variable="$success" />
					<save_retval name="traderesult" variable="$traderesult" />
				</run_script>

				<do_if value="not $success">
					<set_value name="$selloffer" exact="null" />
					<set_value name="$buyoffer" exact="null" />
					<set_value name="$Seller" exact="null" />
					<set_value name="$Buyer" exact="null" />
					<break />
				</do_if>
				<do_if value="$success">
					<do_if value="@$selloffer.available" negate="true">
						<set_value name="$profit" exact="$traderesult.{4}" operation="add" />
						<set_value name="$priceSell" exact="$traderesult.{4}" />
					</do_if>
					<do_if value="@$buyoffer.available" negate="true">
						<set_value name="$profit" exact="$traderesult.{4}" operation="subtract" />
						<set_value name="$priceBuy" exact="$traderesult.{4}" />
					</do_if>
				</do_if>
				<wait min="500ms" max="1s" sinceversion="1" />
			</do_while>

			<do_if value="$success">
				<set_known object="this.ship.cluster" known="true" />
				<set_known object="this.ship.sector" known="true" />
				<set_known object="this.ship.zone" known="true" />
				<do_if value="this.ship.isclass.ship_l or this.ship.isclass.ship_xl" negate="true">
					<set_value name="$CommissionAmount"
						exact="4*(this.$jlp_unitrader_extrafaction + this.$jlp_unitrader_courage + this.$jlp_unitrader_efficiency) /300" />
					<set_value name="$CommissionTime"
						exact="30min*(this.$jlp_unitrader_extrafaction + this.$jlp_unitrader_courage + this.$jlp_unitrader_efficiency) /300" />
				</do_if>
				<do_else>
					<set_value name="$CommissionAmount"
						exact="10*(this.$jlp_unitrader_extrafaction + this.$jlp_unitrader_courage + this.$jlp_unitrader_efficiency) /300" />
					<set_value name="$CommissionTime"
						exact="1h*(this.$jlp_unitrader_extrafaction + this.$jlp_unitrader_courage + this.$jlp_unitrader_efficiency) /300" />

				</do_else>


				<substitute_text text="$notiDearsPilot" source="{8570,2}">
					<replace string="'$ENTITYTYPE$'" with="this.typename" />
					<replace string="'$ENTITYNAME$'" with="this.name" />
					<replace string="'$OBJECTNAME$'" with="this.ship.name" />
					<replace string="'$SECTOR$'" with="this.sector.name" />
				</substitute_text>
				<substitute_text text="$notiDearsShip" source="{8570,4}">
					<replace string="'$ENTITYTYPE$'" with="this.typename" />
					<replace string="'$ENTITYNAME$'" with="this.name" />
					<replace string="'$OBJECTNAME$'" with="this.ship.name" />
					<replace string="'$SECTOR$'" with="this.sector.name" />
				</substitute_text>

				<do_if value="$buyoffer.exists" negate="true">
					<do_if value="@$Buyer.exists">
						<do_if value="$Buyer.owner != faction.player">
							<set_known object="$Buyer" known="true" />
							<wait min="4s" max="9s" />
							<set_faction_known faction="$Buyer.owner" known="true" />
							<wait min="4s" max="9s" />
							<add_faction_relation faction="faction.player" otherfaction="$Buyer.owner"
								value="this.$jlp_unitrader_extrafaction/100000" />
							<wait min="4s" max="9s" />
							<add_player_discount name="$notiDearsShip" amount="$CommissionAmount"
								entity="$BuyerEntity" time="$CommissionTime" />
						</do_if>
					</do_if>
				</do_if>

				<do_if value="$selloffer.exists" negate="true">
					<do_if value="@$Seller.exists">
						<do_if value="$Seller.owner != faction.player">
							<set_known object="$Seller" known="true" />
							<wait min="4s" max="9s" />
							<set_faction_known faction="$Seller.owner" known="true" />
							<wait min="4s" max="9s" />
							<add_faction_relation faction="faction.player" otherfaction="$Seller.owner"
								value="this.$jlp_unitrader_extrafaction/100000" />
							<wait min="4s" max="9s" />
							<add_player_commission name="$notiDearsShip" amount="$CommissionAmount"
								entity="$SellerEntity" time="$CommissionTime" />
						</do_if>
					</do_if>
				</do_if>
				<do_if value="$buyoffer.exists and $selloffer.exists" negate="true">
					<!-- is success when offer is gone and trade is succesfull -->
					<do_if value="@$Buyer.exists and @$Seller.exists">
						<do_if value="this.$jlp_unitrader_show_extendedlogbook">
							<substitute_text text="$detail1" source="{8570,50400}">
								<replace string="'$SHIP$'" with="$notiDearsShip" />
								<replace string="'$PROFIT$'" with="$profit" />
								<replace string="'$WARE$'" with="$traderesult.{3}" />
								<replace string="'$AMOUNT$'" with="$traderesult.{2}" />
								<replace string="'$PRICEBUY$'" with="$priceBuy" />
								<replace string="'$PRICESELL$'" with="$priceSell" />
								<replace string="'$STATION$'" with="$traderesult.{1}" />
							</substitute_text>

							<wait min="4s" max="9s" />
							<write_to_logbook category="squad" text="$detail1" />
						</do_if>
						<run_script name="'jlp.unitrader.skills'" sinceversion="1">
							<param name="Mode" value="'learn'" />
							<param name="debugchance" value="$debugchance" />
						</run_script>

					</do_if>
				</do_if>

			</do_if>
			<debug_text text="player.age + ' END OF SCRIPT!'" chance="$debugchance" />

		</actions>
	</attention>
	<on_abort>
		<do_if value="@$buyoffer.available">
			<remove_ware_reservation object="$buyoffer.buyer" entity="this" />
		</do_if>
		<do_if value="@$selloffer.available">
			<remove_ware_reservation object="$selloffer.seller" entity="this" />
		</do_if>
	</on_abort>
</aiscript>
