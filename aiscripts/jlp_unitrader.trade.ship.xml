<?xml version="1.0" encoding="iso-8859-1" ?>
<aiscript name="jlp.unitrader.trade.ship" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="aiscripts.xsd" version="1">
	<params>
		<param name="PageId" default="8570"/>
		<param name="warelist" default="null" />
		<param name="range" default="null" />
		<!--if $range == 'ranged' then $additionalparams defines min and max jumps for the buy and sell ranges [$minbuy, $maxbuy, $minsell, $maxsell]-->
		<param name="additionalparams" default="null" />

		<param name="debugchance" default="0" />
		<param name="debugchance2" default="0" />
	</params>

	<attention min="unknown">
		<actions>
			<wait_for_prev_script/>    
            <save_ai_action_state entity="this" previous="this"/>
			
			<!-- set up initial state for trade runs -->
			<label name="start" />

			<set_value name="$Pilot" exact="this.knownname"/>
			<set_value name="$buyoffer" exact="null" />
			<set_value name="$selloffer" exact="null" />

			<set_value name="$idletime" min="10s" max="30s" />
			<wait chance="0" />
			<run_script name="'move.idle'" sinceversion="1">
				<param name="TimeOut" value="$idletime" />
			</run_script>

			<!-- TODO: we should check for things like broken jump drive, so we can go in for repairs instead of endlessly trying to jump to a trade -->

			<set_value name="$sellrange" exact="null"/>
			<set_value name="$buyrange" exact="null"/>
			<do_if value="not @$range.isclass.space">
				<do_if value="$range" exact="'zone'">
					<set_value name="$range" exact="this.ship.zone" />
				</do_if>
				<do_elseif value="$range" exact="'sector'">
					<set_value name="$range" exact="this.ship.sector" />
				</do_elseif>
				<do_elseif value="$range" exact="'cluster'">
					<set_value name="$range" exact="this.ship.cluster" />
				</do_elseif>
				<do_elseif value="$range" exact="'ranged'">
					<set_value name="$range" exact="this.ship.cluster" />
					<set_value name="$sellrange" exact="[$additionalparams.{1}, $additionalparams.{2}]"/>
					<set_value name="$buyrange" exact="[$additionalparams.{3}, $additionalparams.{4}]"/>

					<do_if value="this.$traderange_sellclusters?">
						<remove_value name="this.$traderange_nexttime"/>
						<remove_value name="this.$traderange_sellclusters"/>
					</do_if>
				</do_elseif>
				<do_else>
					<do_if value="this.ship.isclass.ship_l or this.ship.isclass.ship_xl">
						<set_value name="$range" exact="this.ship.cluster" />
					</do_if>
					<do_else>
						<set_value name="$range" exact="this.ship.sector" />
					</do_else>
				</do_else>
			</do_if>

			<!-- TODO use ware basket unless it has been overridden by parameter -->
			<do_if value="$warelist == null">
				<set_value name="$warelist" exact="this.ship.warebasket.list" />
			</do_if>

			<do_if value="this.ship.cargo.{ware.fuelcells}.count lt 800">
				<set_value name="$ActualZone" exact="this.zone" />
				<run_script name="'move.refuel'" sinceversion="1" />
				<do_if value="this.zone != $ActualZone">
					<run_script name="'move.generic'" sinceversion="1">
						<param name="destination" value="$ActualZone" />
					</run_script>
				</do_if>
			</do_if>

			<label name="find trade run"/>

			<wait exact="this.$jlp_unitrader_searchtime" />

			<do_if value="@this.ship.dockslot.component.external">
				<!-- make sure we clear the docking area asap -->
				<run_script name="'move.undock'" sinceversion="1" />
				<set_value name="$idletime" min="10s" max="30s" />
				<run_script name="'move.idle'" sinceversion="1">
					<param name="TimeOut" value="$idletime" />
				</run_script>
			</do_if>
			<do_else>
				<wait min="10s" max="30s" />
			</do_else>

			<!--Patch in $debugchance2, $sellrange and $buyrange-->
			<do_if value="not $sellrange?">
				<set_value name="$debugchance2" exact="0"/>
				<set_value name="$sellrange" exact="null"/>
				<set_value name="$buyrange" exact="null"/>
			</do_if>

			<run_script name="'jlp.unitrader.trade.findfreetraderun'" sinceversion="1">
				<param name="warelist" value="$warelist" />
				<param name="range" value="$range" />
				<param name="sellrange" value="$sellrange"/>
				<param name="buyrange" value="$buyrange"/>
				<param name="debugchance" value="$debugchance"/>
				<param name="debugchance2" value="$debugchance2"/>
				<save_retval name="selloffer" variable="$selloffer" />
				<save_retval name="buyoffer" variable="$buyoffer" />
			</run_script>

			<!--If no trade was found then at least fly back to the buy area before checking again-->
			<do_if value="not $selloffer.available and not $buyoffer.available">
				<set_value name="this.$trade_failedfindruns" operation="add"/>
				<!--If the buyclusters are saved to the blackboard, fly to one of them-->
				<do_if value="this.$traderange_buyclusters?">
					<set_value name="$moveto" exact="true"/>
					<do_if value="this.$traderange_buyclusters.count">
						<!--Check if we are already in the buy area-->
						<do_all exact="this.$traderange_buyclusters.count" counter="$Counter">
							<do_if value="this.ship.hascontext.{this.$traderange_buyclusters.{$Counter}}">
								<set_value name="$moveto" exact="false"/>
								<break/>
							</do_if>
						</do_all>
						<do_if value="$moveto">
							<debug_text text="'No trade was found and we are outside of the buy range. Flying back to buy range.'"/>
							<run_script name="'move.generic'" sinceversion="1">
								<param name="destination" value="this.$traderange_buyclusters.random" />
							</run_script>
						</do_if>
						<remove_value name="$moveto"/>
					</do_if>
				</do_if>
				<resume label="find trade run"/>
			</do_if>

			<label name="perform trade run"/>

			<set_value name="this.$trade_failedfindruns" exact="0"/>

			<!-- remember for notification -->
			<do_if value="$buyoffer.available">
				<set_value name="$Buyer" exact="$buyoffer.buyer"/>
				<set_value name="$BuyerEntity" exact="$buyoffer.buyerentity"/>
				<set_value name="$tradeBuyWare" exact="$buyoffer.ware"/>
				<set_value name="$tradeBuyWareOfferAmount" exact="$buyoffer.offeramount.{this}"/>
				<set_value name="$tradeBuyOfferUnitprice" exact="$buyoffer.unitprice"/>
				<set_value name="$tradeBuyOfferPrice" exact="$buyoffer.price"/>
			</do_if>
			<do_if value="$selloffer.available">
				<set_value name="$Seller" exact="$selloffer.seller"/>
				<set_value name="$SellerEntity" exact="$selloffer.sellerentity"/>
				<set_value name="$tradeSellWare" exact="$selloffer.ware"/>
				<set_value name="$tradeSellWareOfferAmount" exact="$selloffer.offeramount.{this}"/>
				<set_value name="$tradeSellOfferUnitprice" exact="$selloffer.unitprice"/>
				<set_value name="$tradeSellOfferPrice" exact="$selloffer.price"/>
			</do_if>


			<set_value name="$success" exact="false"/>
			<do_while value="$selloffer.available or $buyoffer.available">
            	<wait_for_prev_script/>    
                <save_ai_action_state entity="this" previous="this"/>
				<run_script name="'jlp.unitrader.trade.performtraderun'" sinceversion="1">
					<param name="selloffer" value="$selloffer" />
					<param name="buyoffer" value="$buyoffer" />
					<param name="debugchance" value="$debugchance" />
					<save_retval name="success" variable="$success" />
					<save_retval name="traderesult" variable="$traderesult" />
				</run_script>

				<do_if value="not $success">
					<set_value name="$selloffer" exact="null" />
					<set_value name="$buyoffer" exact="null" />
					<set_value name="$Seller" exact="null"/>
					<set_value name="$Buyer" exact="null"/>
					<break/>
				</do_if>
			
				<wait exact="this.$jlp_unitrader_searchtime" />
			</do_while>

			<do_if value="$success">
				<set_known object="this.ship.cluster" known="true"/>
				<set_known object="this.ship.sector" known="true"/>
				<set_known object="this.ship.zone" known="true"/>
				<set_value name="$CommissionAmount" exact="10*(this.$jlp_unitrader_extrafaction + this.$jlp_unitrader_courage + this.$jlp_unitrader_efficiency) /300"/>
				<set_value name="$CommissionTime" exact="1h*(this.$jlp_unitrader_extrafaction + this.$jlp_unitrader_courage + this.$jlp_unitrader_efficiency) /300"/>


				<substitute_text text="$notiDearsPilot" source="{8570,2}">
					<replace string="'$ENTITYTYPE$'" with="this.typename" />
					<replace string="'$ENTITYNAME$'" with="this.name" />
					<replace string="'$OBJECTNAME$'" with="this.ship.name" />
					<replace string="'$SECTOR$'" with="this.sector.name" />
				</substitute_text>
				<substitute_text text="$notiDearsShip" source="{8570,4}">
					<replace string="'$ENTITYTYPE$'" with="this.typename" />
					<replace string="'$ENTITYNAME$'" with="this.name" />
					<replace string="'$OBJECTNAME$'" with="this.ship.name" />
					<replace string="'$SECTOR$'" with="this.sector.name" />
				</substitute_text>

				<do_if value="$buyoffer.exists" negate="true">
					<do_if value="@$Buyer.exists">
						<do_if value="$Buyer.owner != faction.player">
							<set_known object="$Buyer" known="true"/>
							<wait min="4s" max="9s"/>
							<set_faction_known  faction="$Buyer.owner" known="true"/>
							<wait min="4s" max="9s"/>
							<add_faction_relation  faction="faction.player" otherfaction="$Buyer.owner" value="this.$jlp_unitrader_extrafaction/1000000"/>
							<wait min="4s" max="9s"/>
							<add_player_discount name="$notiDearsPilot" amount="$CommissionAmount" entity="$BuyerEntity" time="$CommissionTime" />
						</do_if>
					</do_if>
				</do_if>
				<do_if value="$selloffer.exists" negate="true">
					<do_if value="@$Seller.exists">
						<do_if value="$Seller.owner != faction.player">
							<set_known object="$Seller" known="true"/>
							<wait min="4s" max="9s"/>
							<set_faction_known faction="$Seller.owner" known="true"/>
							<wait min="4s" max="9s"/>
							<add_faction_relation faction="faction.player" otherfaction="$Seller.owner" value="this.$jlp_unitrader_extrafaction/1000000"/>
							<wait min="4s" max="9s"/>
							<add_player_commission name="$notiDearsPilot" amount="$CommissionAmount" entity="$SellerEntity" time="$CommissionTime" />
						</do_if>
					</do_if>
				</do_if>
				<do_if value="$buyoffer.exists and $selloffer.exists" negate="true">
					<!-- is success when offer is gone and trade is succesfull-->
					<do_if value="@$Buyer.exists and @$Seller.exists">
						<substitute_text text="$detail1" source="{8570,50400}">
							<replace string="'$TRADE$'" with="$traderesult" />
						</substitute_text>

						<wait min="4s" max="9s"/>
						<write_to_logbook category="squad" text="$detail1"/>

						<run_script name="'jlp.unitrader.skills'" sinceversion="1">
							<param name="Mode" value="'learn'"/>
							<param name="debugchance"  value="$debugchance"/>
						</run_script>

					</do_if>
				</do_if>
			</do_if>

			<debug_text text="player.age + ' END OF SCRIPT!'" chance="$debugchance" />

		</actions>
	</attention>
	<on_abort>
		<do_if value="@$buyoffer.available">
			<remove_ware_reservation object="$buyoffer.buyer" entity="this" />
		</do_if>
		<do_if value="@$selloffer.available">
			<remove_ware_reservation object="$selloffer.seller" entity="this" />
		</do_if>
	</on_abort>
</aiscript>
