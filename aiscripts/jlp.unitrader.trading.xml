<?xml version="1.0" encoding="iso-8859-1" ?>
<aiscript name="jlp.unitrader.trading" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:noNamespaceSchemaLocation="aiscripts.xsd" version="1"
>
	<params>
		<param name="PageId" default="8570" />
		<param name="maxBudget" default="100000000ct" />
		<param name="range" default="'ranged'" />
		<param name="homeStart" default="this.ship.zone" />
	</params>
	<interrupts>
		<handler ref="JLPUnitraderTargetInvalidHandler" />
		<handler ref="JLPUnitraderShipOwnedAttackedHandler" />
		<handler ref="JLPUnitraderScannedHandler" />
	</interrupts>
	<attention min="unknown">
		<actions>
			<!-- trade loop start -->
			<label name="start" />
			<wait chance="0" exact="0s" /> <!-- Reset script if new -->

			<do_if value="@this.$jlpUniTraderRun" exact="true">
				<!-- initial -->

				<run_script name="'jlp.unitrader.skills'" sinceversion="1">
					<param name="Mode" value="'init'" />
				</run_script>

				<!-- ############## read from config ###################### -->
				<do_if value="typeof @this.$jlp_unitrader_budgetmax == datatype.money">
					<set_value name="$maxBudget" exact="this.$jlp_unitrader_budgetmax" />
				</do_if>
				<do_else>
					<do_if value="typeof $maxBudget != datatype.money">
						<do_if value="this.ship.isclass.ship_l or this.ship.isclass.ship_xl">
							<set_value name="$maxBudget" exact="1000000000ct" />
						</do_if>
						<do_else>
							<set_value name="$maxBudget" exact="100000000ct" />
						</do_else>
						<set_value name="this.$jlp_unitrader_budgetmax" exact="$maxBudget" />
					</do_if>
				</do_else>
				<!-- Range -->
				<do_if value="@this.$jlp_unitrader_range != null">
					<set_value name="$range" exact="this.$jlp_unitrader_range" />
				</do_if>
				<do_else>
					<do_if value="$range == null">
						<set_value name="$range" exact="'ranged'" />
					</do_if>
					<set_value name="this.$jlp_unitrader_range" exact="$range" />
				</do_else>
				<do_if value="@this.$jlp_unitrader_home != null">
					<set_value name="$homeStart" exact="this.$jlp_unitrader_home" />
				</do_if>
				<do_else>
					<do_if value="$homeStart == null">
						<set_value name="$homeStart" exact="this.ship.zone" />
					</do_if>
					<set_value name="this.$jlp_unitrader_home" exact="$homeStart" />
				</do_else>
				<do_if value="$range == 'ranged'">
					<!-- Jump -->
					<do_if value="typeof @this.$jlp_unitrader_jump_buy_min == datatype.integer">
						<set_value name="$minbuy" exact="this.$jlp_unitrader_jump_buy_min" />
					</do_if>
					<do_else>
						<set_value name="this.$jlp_unitrader_jump_buy_min" exact="0" />
						<set_value name="$minbuy" exact="this.$jlp_unitrader_jump_buy_min" />
					</do_else>
					<do_if value="typeof @this.$jlp_unitrader_jump_buy_max == datatype.integer">
						<set_value name="$maxbuy"
							exact="this.$jlp_unitrader_jump_buy_max * this.$jlp_unitrader_courage/100i" />
					</do_if>
					<do_else>
						<set_value name="this.$jlp_unitrader_jump_buy_max" exact="2" />
						<set_value name="$maxbuy"
							exact="this.$jlp_unitrader_jump_buy_max * this.$jlp_unitrader_courage/100i" />
					</do_else>
					<do_if value="typeof @this.$jlp_unitrader_jump_sell_min == datatype.integer">
						<set_value name="$minsell" exact="this.$jlp_unitrader_jump_sell_min" />
					</do_if>
					<do_else>
						<set_value name="this.$jlp_unitrader_jump_sell_min" exact="0" />
						<set_value name="$minsell" exact="this.$jlp_unitrader_jump_sell_min" />
					</do_else>
					<do_if value="typeof @this.$jlp_unitrader_jump_sell_max == datatype.integer">
						<set_value name="$maxsell"
							exact="this.$jlp_unitrader_jump_sell_max * this.$jlp_unitrader_courage/100i" />
					</do_if>
					<do_else>
						<set_value name="this.$jlp_unitrader_jump_sell_max" exact="2" />
						<set_value name="$maxsell"
							exact="this.$jlp_unitrader_jump_sell_max * this.$jlp_unitrader_courage/100i" />
					</do_else>
				</do_if>
				<do_else>
					<remove_value name="this.$jlp_unitrader_jump_sell_max" />
					<remove_value name="this.$jlp_unitrader_jump_sell_min" />
					<remove_value name="this.$jlp_unitrader_jump_buy_max" />
					<remove_value name="this.$jlp_unitrader_jump_buy_min" />
				</do_else>
				<!-- Set parameters -->
				<set_actor_min_budget actor="this" amount="0ct" />
				<set_actor_max_budget actor="this" amount="$maxBudget*10ct" />


				<!--<set_actor_max_budget actor="this" amount="$MaxBudget"/> -->
				<!-- check maxbudget and give the rest to player -->
				<do_if value="this.money" min="$maxBudget">
					<set_value name="$transferMoney" exact="this.money - $maxBudget" />
					<wait min="4s" max="9s" />
					<do_if value="$transferMoney" min="1">
						<transfer_money from="this" to="player.entity" amount="$transferMoney" result="$result" />
						<add_npc_line speaker="this" line="1164" comment="More Money as max, tranfer the rest" />
						<write_to_logbook category="squad"
							text="{8570,50100}.[this.ship.knownname, this.knownname, $transferMoney.formatted.default]" />
						<wait min="4s" max="9s" />
					</do_if>
				</do_if>
				<do_if value="$range == 'ranged'">
					<run_script name="'jlp.unitrader.trade.ship.ranged'" sinceversion="1">
						<param name="range" value="$range" />
						<param name="home" value="$homeStart" />
						<param name="PageId" value="$PageId" />
						<param name="minbuy" value="$minbuy" />
						<param name="maxbuy" value="$maxbuy" />
						<param name="minsell" value="$minsell" />
						<param name="maxsell" value="$maxsell" />
					</run_script>
				</do_if>
				<do_else>
					<run_script name="'jlp.unitrader.trade.ship.ranged'" sinceversion="1">
						<param name="range" value="$range" />
						<param name="home" value="$homeStart" />
						<param name="PageId" value="$PageId" />
					</run_script>
				</do_else>

				<resume label="start" />
			</do_if>
			<do_else>
				<!-- Finished trade and follow player -->
				<add_npc_line speaker="this" line="1058" comment="Ready for new orders, Sir." />
			</do_else>
		</actions>
	</attention>
	<on_abort>
		<set_value name="this.$jlpUniTraderRun" exact="false" />
	</on_abort>
</aiscript>
