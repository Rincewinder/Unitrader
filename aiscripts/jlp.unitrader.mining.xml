<?xml version="1.0" encoding="iso-8859-1" ?>
<aiscript name="jlp.unitrader.mining" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:noNamespaceSchemaLocation="aiscripts.xsd" version="2"
>
	<params>
		<param name="PageId" default="8570" />
		<param name="maxBudget" default="100000000ct" />
		<param name="debugchance" default="0" />
	</params>

	<interrupts>
		<handler ref="JLPUnitraderTargetInvalidHandler" />
		<handler ref="JLPUnitraderShipOwnedAttackedHandler" />
		<handler ref="JLPUnitraderScannedHandler" />
	</interrupts>

	<attention min="unknown">
		<actions>

			<!-- trade loop start -->
			<label name="start" />
			<wait chance="0" /> <!-- Reset script if new -->
			<set_command_action commandaction="commandaction.standingby" />
			<!-- initial -->
			<set_actor_account actor="this"  />
			<set_actor_max_budget amount="$maxBudget*10" actor="this"/>
			<set_actor_min_budget amount="0ct" actor="this"/>
			

			<do_if value="this.$jlpUniMiningRun" exact="true">
				<!-- Init -->
				<run_script name="'jlp.unitrader.skills'" sinceversion="1">
					<param name="Mode" value="'init'" />
					<param name="debugchance" value="$debugchance" />
				</run_script>
				
				<!-- ############## read from config ###################### -->
				<do_if value="typeof @this.$jlp_unitrader_budgetmax == datatype.money">
					<set_value name="$maxBudget" exact="this.$jlp_unitrader_budgetmax" />
				</do_if>
				<do_else>
					<do_if value="typeof $maxBudget != datatype.money">
						<do_if value="this.ship.isclass.ship_l or this.ship.isclass.ship_xl">
							<set_value name="$maxBudget" exact="5000000ct" />
						</do_if>
						<do_else>
							<set_value name="$maxBudget" exact="500000ct" />
						</do_else>
						<set_value name="this.$jlp_unitrader_budgetmax" exact="$maxBudget" />
					</do_if>
				</do_else>

				<!-- check maxbudget and give the rest to player -->
				<do_if value="this.money" min="$maxBudget">
					<set_value name="$transferMoney" exact="$maxBudget / 2" />
					<wait min="4s" max="9s" />
					<do_if value="$transferMoney" min="1">
						<transfer_money from="this" to="player.entity"
							amount="$transferMoney" result="$result" />
						<write_to_logbook category="squad"
							text="{8570,50100}.[this.ship.knownname, this.knownname, $transferMoney.formatted.default]" />
						<wait min="4s" max="9s" />
					</do_if>
				</do_if>

				<!-- TODO: change to check ship tags instead of cargo, so we can deal 
					with count = 0 cases; needs adding of ?? -->
				<create_list name="$orelist" />

				<do_if value="this.ship.units.{unitcategory.gascollector}.count">

					<set_value name="$ware" exact="ware.hydrogen" />
					<do_if value="this.ship.cargo.{$ware}.max" min="1">
						<append_to_list name="$orelist" exact="$ware" />
					</do_if>

					<set_value name="$ware" exact="ware.ions" />
					<do_if value="this.ship.cargo.{$ware}.max" min="1">
						<append_to_list name="$orelist" exact="$ware" />
					</do_if>
					<set_value name="$ware" exact="ware.plasma" />
					<do_if value="this.ship.cargo.{$ware}.max" min="1">
						<append_to_list name="$orelist" exact="$ware" />
					</do_if>
					<set_value name="$ware" exact="ware.plasma" />
					<do_if value="this.ship.cargo.{$ware}.max" min="1">
						<append_to_list name="$orelist" exact="$ware" />
					</do_if>

				</do_if>

				<do_if value="this.ship.units.{unitcategory.orecollector}.count">
					<set_value name="$ware" exact="ware.ore" />
					<do_if value="this.ship.cargo.{$ware}.max" min="1">
						<append_to_list name="$orelist" exact="$ware" />
					</do_if>
					<set_value name="$ware" exact="ware.silicon" />
					<do_if value="this.ship.cargo.{$ware}.max" min="1">
						<append_to_list name="$orelist" exact="$ware" />
					</do_if>
					<set_value name="$ware" exact="ware.crystals" />
					<do_if value="this.ship.cargo.{$ware}.max" min="1">
						<append_to_list name="$orelist" exact="$ware" />
					</do_if>
					<set_value name="$ware" exact="ware.nividium" />
					<do_if value="this.ship.cargo.{$ware}.max" min="1">
						<append_to_list name="$orelist" exact="$ware" />
					</do_if>
					<set_value name="$ware" exact="ware.ice" />
					<do_if value="this.ship.cargo.{$ware}.max" min="1">
						<append_to_list name="$orelist" exact="$ware" />
					</do_if>
				</do_if>


				<wait min="4s" max="9s" />
				<run_script name="'jlp.unitrader.mining.ship.ranged'"
					sinceversion="1"
				>
					<param name="PageId" value="$PageId" />
					<param name="basket" value="$orelist" />
					<param name="debugchance" value="$debugchance" />
				</run_script>
				<!-- Take a break -->
				<wait exact="this.$jlp_unitrader_waittime" />

				<resume label="start" />
			</do_if>
			<do_else>
				<!-- Finished -->
				<add_npc_line speaker="this" line="1058"
					comment="Ready for new orders, Sir." />
			</do_else>
		</actions>
	</attention>
	<on_abort>
		<set_value name="this.$jlpUniMiningRun" exact="false" />
	</on_abort>
</aiscript>
