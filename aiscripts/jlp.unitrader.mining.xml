<?xml version="1.0" encoding="iso-8859-1" ?>
<aiscript name="jlp.unitrader.mining" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="aiscripts.xsd"  version="1">
    <params>
        <param name="PageId" default="8570" />
        <param name="maxBudget"   default="100000000ct"/>
        <param name="debugchance" default="0"/>
    </params>
	<!--
	<interrupts>
        <handler ref="AttackHandler" />
        <handler ref="ScannedHandler" />
    </interrupts>
 
        <handler>
            <conditions>
                <event_object_money_updated object="this"/>
            </conditions>
            <actions>
                <do_if value="(this.minbudget gt 0) and (this.money lt this.minbudget)">
                    <debug_text text="'money below budget. Money: ' + event.param2 + ' Min budget: ' + this.minbudget" chance="$debugchance"/>

                    <run_interrupt_script name="'player.interaction.budget'"/>
                </do_if>
            </actions>
        </handler>
    </interrupts>
-->

    <attention min="unknown">
        <actions>

            <!-- trade loop start -->
            <label name="start" />

            <!--  initial  -->
			<set_actor_account actor="this" min="0ct" max="$maxBudget*10"/>


            <do_if value="this.$jlpUniMiningRun" exact="true">

                <!--<set_actor_max_budget actor="this" amount="$MaxBudget"/>  -->
                <!--   check maxbudget and give the rest to player -->
                <do_if value="this.money" min="$maxBudget">
                    <set_value name="$transferMoney" exact="this.money - $maxBudget"/>
                    <wait min="4s" max="9s"/>
					<do_if value="$transferMoney" min="1">
						<transfer_money from="this" to="player.entity" amount="$transferMoney" result="$result" />
						<write_to_logbook category="squad" text="{8570,50100}.[this.ship.knownname, this.knownname, $transferMoney/1Cr]"/>
						<wait min="4s" max="9s"/>
					</do_if>
                </do_if>
                <run_script name="'jlp.unitrader.skills'">
                    <param name="Mode" value="'init'"/>
                    <param name="debugchance"  value="$debugchance"/>
                </run_script>

				<!-- TODO: change to check ship tags instead of cargo, so we can deal with count = 0 cases; needs adding of ?? -->
				<create_list name="$orelist" />

				<do_if value="this.ship.units.{unitcategory.gascollector}.count">

					<set_value name="$ware" exact="ware.hydrogen" />
					<do_if value="this.ship.cargo.{$ware}.max" min="1">
						<append_to_list name="$orelist" exact="$ware"/>
					</do_if>
				
					<set_value name="$ware" exact="ware.ions" />
					<do_if value="this.ship.cargo.{$ware}.max" min="1">
						<append_to_list name="$orelist" exact="$ware"/>
					</do_if>
					<set_value name="$ware" exact="ware.plasma" />
					<do_if value="this.ship.cargo.{$ware}.max" min="1">
						<append_to_list name="$orelist" exact="$ware"/>
					</do_if>
					<set_value name="$ware" exact="ware.plasma" />
					<do_if value="this.ship.cargo.{$ware}.max" min="1">
						<append_to_list name="$orelist" exact="$ware"/>
					</do_if>

				</do_if>

				<do_if value="this.ship.units.{unitcategory.orecollector}.count">
					<set_value name="$ware" exact="ware.ore" />
					<do_if value="this.ship.cargo.{$ware}.max" min="1">
						<append_to_list name="$orelist" exact="$ware"/>
					</do_if>
					<set_value name="$ware" exact="ware.silicon" />
					<do_if value="this.ship.cargo.{$ware}.max" min="1">
						<append_to_list name="$orelist" exact="$ware"/>
					</do_if>
					<set_value name="$ware" exact="ware.crystals" />
					<do_if value="this.ship.cargo.{$ware}.max" min="1">
						<append_to_list name="$orelist" exact="$ware"/>
					</do_if>
					<set_value name="$ware" exact="ware.nividium" />
					<do_if value="this.ship.cargo.{$ware}.max" min="1">
						<append_to_list name="$orelist" exact="$ware"/>
					</do_if>
					<set_value name="$ware" exact="ware.ice" />
					<do_if value="this.ship.cargo.{$ware}.max" min="1">
						<append_to_list name="$orelist" exact="$ware"/>
					</do_if>
				</do_if>


				<wait min="4s" max="9s"/>
            	<wait_for_prev_script/>    
                <save_ai_action_state entity="this" previous="this"/>
                <run_script name="'jlp.unitrader.mining.ship.ranged'">
                    <param name="PageId" value="$PageId"/>
					<param name="basket" value="$orelist" />
                    <param name="debugchance"  value="$debugchance"/>
                </run_script>
                <!-- Take a break -->
                <wait exact="this.$jlp_unitrader_waittime"/>

                <resume label="start" />
            </do_if>
			<do_else>
				<!-- Finished -->
				<add_npc_line speaker="this" line="1058" comment="Ready for new orders, Sir."/>
			</do_else>
        </actions>
    </attention>
	<on_abort>
		<set_value name="this.$jlpUniMiningRun" exact="false"/>
	</on_abort>
</aiscript>
